/* Date: 2016-04-26T18:56:06Z Path: js/touch/product/detail_main.js */
define("swipe",["ui"],function(t){function e(t,e){function n(){h=$.children,v=h.length,h.length<2&&(e.continuous=!1),m.transitions&&e.continuous&&h.length<3&&($.appendChild(h[0].cloneNode(!0)),$.appendChild($.children[1].cloneNode(!0)),h=$.children),g=new Array(h.length),f=t.getBoundingClientRect().width||t.offsetWidth,$.style.width=h.length*f+"px";for(var n=h.length;n--;){var i=h[n];i.style.width=f+"px",i.setAttribute("data-index",n),m.transitions&&(i.style.left=n*-f+"px",r(n,w>n?-f:n>w?f:0,0))}e.continuous&&m.transitions&&(r(o(w-1),-f,0),r(o(w+1),f,0)),m.transitions||($.style.left=w*-f+"px"),t.style.visibility="visible"}function i(){e.continuous?s(w-1):w&&s(w-1)}function a(){e.continuous?s(w+1):w<h.length-1&&s(w+1)}function o(t){return(h.length+t%h.length)%h.length}function s(t,n){if(w!=t){if(m.transitions){var i=Math.abs(w-t)/(w-t);if(e.continuous){var a=i;i=-g[o(t)]/f,i!==a&&(t=-i*h.length+t)}for(var s=Math.abs(w-t)-1;s--;)r(o((t>w?t:w)-s-1),f*i,0);t=o(t),r(w,f*i,n||b),r(t,0,n||b),e.continuous&&r(o(t-i),-(f*i),0)}else t=o(t),l(w*-f,t*-f,n||b);w=t,_(e.callback&&e.callback(w,h[w]))}}function r(t,e,n){c(t,e,n),g[t]=e}function c(t,e,n){var i=h[t],a=i&&i.style;a&&(a.webkitTransitionDuration=a.MozTransitionDuration=a.msTransitionDuration=a.OTransitionDuration=a.transitionDuration=n+"ms",a.webkitTransform="translate("+e+"px,0)translateZ(0)",a.msTransform=a.MozTransform=a.OTransform="translateX("+e+"px)")}function l(t,n,i){if(!i)return void($.style.left=n+"px");var a=+new Date,o=setInterval(function(){var s=+new Date-a;return s>i?($.style.left=n+"px",k&&d(),e.transitionEnd&&e.transitionEnd.call(event,w,h[w]),void clearInterval(o)):void($.style.left=(n-t)*(Math.floor(s/i*100)/100)+t+"px")},4)}function d(){x=setTimeout(a,k)}function u(){k=0,clearTimeout(x)}var p=function(){},_=function(t){setTimeout(t||p,0)},m={addEventListener:!!window.addEventListener,touch:"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,transitions:function(t){var e=["transitionProperty","WebkitTransition","MozTransition","OTransition","msTransition"];for(var n in e)if(void 0!==t.style[e[n]])return!0;return!1}(document.createElement("swipe"))};if(t){var h,g,f,v,$=t.children[0];e=e||{};var w=parseInt(e.startSlide,10)||0,b=e.speed||300;e.continuous=void 0!==e.continuous?e.continuous:!0;var x,y,k=e.auto||0,j={},C={},E={handleEvent:function(t){switch(t.type){case"touchstart":this.start(t);break;case"touchmove":this.move(t);break;case"touchend":_(this.end(t));break;case"webkitTransitionEnd":case"msTransitionEnd":case"oTransitionEnd":case"otransitionend":case"transitionend":_(this.transitionEnd(t));break;case"resize":_(n)}e.stopPropagation&&t.stopPropagation()},start:function(t){var e=t.touches[0];j={x:e.pageX,y:e.pageY,time:+new Date},y=void 0,C={},$.addEventListener("touchmove",this,!1),$.addEventListener("touchend",this,!1)},move:function(t){if(!(t.touches.length>1||t.scale&&1!==t.scale)){e.disableScroll&&t.preventDefault();var n=t.touches[0];C={x:n.pageX-j.x,y:n.pageY-j.y},"undefined"==typeof y&&(y=!!(y||Math.abs(C.x)<Math.abs(C.y))),y||(t.preventDefault(),u(),e.continuous?(c(o(w-1),C.x+g[o(w-1)],0),c(w,C.x+g[w],0),c(o(w+1),C.x+g[o(w+1)],0)):(C.x=C.x/(!w&&C.x>0||w==h.length-1&&C.x<0?Math.abs(C.x)/f+1:1),c(w-1,C.x+g[w-1],0),c(w,C.x+g[w],0),c(w+1,C.x+g[w+1],0)))}},end:function(){var t=+new Date-j.time,n=Number(t)<250&&Math.abs(C.x)>20||Math.abs(C.x)>f/2,i=!w&&C.x>0||w==h.length-1&&C.x<0;e.continuous&&(i=!1);var a=C.x<0;y||(n&&!i?(a?(e.continuous?(r(o(w-1),-f,0),r(o(w+2),f,0)):r(w-1,-f,0),r(w,g[w]-f,b),r(o(w+1),g[o(w+1)]-f,b),w=o(w+1)):(e.continuous?(r(o(w+1),f,0),r(o(w-2),-f,0)):r(w+1,f,0),r(w,g[w]+f,b),r(o(w-1),g[o(w-1)]+f,b),w=o(w-1)),e.callback&&e.callback(w,h[w])):e.continuous?(r(o(w-1),-f,b),r(w,0,b),r(o(w+1),f,b)):(r(w-1,-f,b),r(w,0,b),r(w+1,f,b))),$.removeEventListener("touchmove",E,!1),$.removeEventListener("touchend",E,!1)},transitionEnd:function(t){parseInt(t.target.getAttribute("data-index"),10)==w&&(k&&d(),e.transitionEnd&&e.transitionEnd.call(t,w,h[w]))}};return n(),k&&d(),m.addEventListener?(m.touch&&$.addEventListener("touchstart",E,!1),m.transitions&&($.addEventListener("webkitTransitionEnd",E,!1),$.addEventListener("msTransitionEnd",E,!1),$.addEventListener("oTransitionEnd",E,!1),$.addEventListener("otransitionend",E,!1),$.addEventListener("transitionend",E,!1)),window.addEventListener("resize",E,!1)):window.onresize=function(){n()},{setup:function(){n()},slide:function(t,e){u(),s(t,e)},prev:function(){u(),i()},next:function(){u(),a()},stop:function(){u()},getPos:function(){return w},getNumSlides:function(){return v},kill:function(){u(),$.style.width="",$.style.left="";for(var t=h.length;t--;){var e=h[t];e.style.width="",e.style.left="",m.transitions&&c(t,0,0)}m.addEventListener?($.removeEventListener("touchstart",E,!1),$.removeEventListener("webkitTransitionEnd",E,!1),$.removeEventListener("msTransitionEnd",E,!1),$.removeEventListener("oTransitionEnd",E,!1),$.removeEventListener("otransitionend",E,!1),$.removeEventListener("transitionend",E,!1),window.removeEventListener("resize",E,!1)):window.onresize=null}}}}t("ui");return e}),define("shoping_car",["ui"],function(t){var e=(t("ui"),{num:$(""),get_userid:function(t){for(var e=document.cookie.split("; "),n=0;n<e.length;n++){var i=e[n].split("=");if(i[0]==t)return unescape(i[1])}},set_num:function(t,n){0!==e.num?$("."+t).find("."+n).length>0?($("."+t).find("."+n).text(e.num),$("."+t).find("."+n).show()):$("."+t).append('<div class="'+n+'">'+e.num+"</div>"):$("."+t).find("."+n).length>0&&$("."+t).find("."+n).hide()},add_shoping:function(t,n,i,a,o){var s="/cart/add",r={items:i,type:a};$.ajax({type:"get",url:s,dataType:"jsonp",jsonp:"callback",data:r,async:!1,success:function(i){o(i),"success"==i.result?(e.num=parseInt($("."+n).text())+1,e.set_num(t,n)):alert(i.message)},error:function(){alert('"抱歉，本商品因信息有误，无法加入购物车。请您告知小美，以便尽快修复：客服热线400-123-8888。"')}})}});return e}),define("detail",["ui","shoping_car","swipe"],function(t){var e=t("ui"),n=t("shoping_car"),i=t("swipe"),a=1e3*$("#start_time").val();if(new e.gotop({bottom:"80px"}),a>0){new e.countdown({selector:"#time",endTime:a,isShow:!0,callback:function(){$(".text_time").html("<span>已结束</span>"),$("#time").hide()}})}var o={type:$("#type").val(),item_id:$("#item_id").val(),pingjia_id:$("#product_id").val(),current_timeout:null,report_index:1,report_pageCount:10,report_number:10,has_clickpj:!1},s=!1;Jumei.getCookie("nickname")&&(s=!0);var r=!1,c={init:function(){this.initPage()},initPage:function(){this.initEvent(),this.initShareFunc(),this.initSales(),this.initeRcommend(),this.initGa(),this.priceRemmind()},initeRcommend:function(){$.ajax({url:"/recommend/sale?item_id="+o.item_id+"&type="+o.type,type:"get",success:function(t){var e="";if(0!==t.item_list.length){e+='<div class="detail_group border_top">',e+='<div class="h5">大家还买了</div>',e+='<div id = "details_recommend" class = "details_recommend swipe">',e+='<ul class="swipe-wrap">';for(var n=0;n<t.item_list.length;n++){var a=t.item_list[n].name?t.item_list[n].name:t.item_list[n].short_name,o="";a.length>20&&(a=a.substring(0,20)+"..."),n%3===0&&(e+="<li>",e+='<ul style="margin: 0px 10px;">'),e+=' <a href = "/product/detail?item_id='+t.item_list[n].item_id+"&type="+t.item_list[n].type+'" class="details_recommend_a">',e+="<li>",e+='<p class = "img"><img src = "'+t.item_list[n].image_url_set.single[320]+'" onerror="this.src="http://s1.jmstatic.com/templates/touch/css/v3/image/bg_logo_1_1.jpg"" ></p>',e+='<p class = "title">'+a+"</p>",e+='<p class = "price">￥'+o+t.item_list[n].jumei_price+"</p>",e+="</li>",e+="</a>",(n%3===2||n===t.item_list.length-1)&&(e+="</ul>",e+="</li>")}e+="</ul>",e+="</div>",e+="</div>",$(".detail_buy").append(e),new i($("#details_recommend")[0],{startSlide:0,continuous:!1,speed:2e3,disableScroll:!1,stopPropagation:!1})}},error:function(){}})},initSales:function(){var t=this;$.ajax({url:"/promo/sales?item_id="+o.item_id+"&type="+o.type,type:"get",success:function(e){t.setSaleHtml(e)},error:function(){}})},setSaleHtml:function(t){if(0!==t.list.length){for(var e=t.list[""+o.type][""+o.item_id].promo_sale_text,n="",i="",a=e.length,s=0;a>s;s++)n+="",n+="type"in e[s]&&"gift"===e[s].type||"content"in e[s]&&""!==e[s].content?'<div class = "h5 sales_item  sales_item_click" id="sales_item_'+s+'">':'<div class = "h5 sales_item" id="sales_item_'+s+'">',n+="color"in e[s]?'<span class="sales_icon" style="background-color:#'+e[s].color+'}">'+e[s].simple_name+"</span>":'<span class="sales_icon">'+e[s].simple_name+"</span>",n+='<a href="javascrit:;" onclick="return false;">',"show_name"in e[s]&&(n+=e[s].show_name),"type"in e[s]&&"gift"===e[s].type&&(n+="(已赠完)"),("type"in e[s]&&"gift"===e[s].type||"content"in e[s]&&""!==e[s].content)&&(n+='<span class = "right"><label></label></span>'),n+="</a>",n+="</div>",i+='<div class="show_sale_item" id="sales_info_'+s+'">',i+='<div class="alert_head">',i+='<span class="close_alert_btn">×</span>',i+="type"in e[s]&&"gift"===e[s].type?"赠品":"规则说明",i+="</div>",i+='<div class="alert_content">',""!==e[s].content&&(i+=' <div class="show_sale_rule">'+e[s].content+"</div>"),i+="</div>",i+="</div>";""!==n&&($("#sale_div").append(n),$("#alert_box").append(i))}},initShareFunc:function(){},initEvent:function(){var t=this,e=$("#detail_nav").offset().top;$("#imgs_tap").tap(function(){$(window).scrollTop()>e&&$(window).scrollTo(e),$("#detail_pingjia").removeClass("current_tap"),$("#detail_imgs").addClass("current_tap"),$(".detail_tap").removeClass("select"),$("#imgs_tap").addClass("select"),$(".tap_content").removeClass("show_right"),$(".tap_content").addClass("hide_right")}),$("#pingjia_tap").tap(function(){$(window).scrollTop()>e&&$(window).scrollTop(e),$("#detail_imgs").removeClass("current_tap"),$("#detail_pingjia").addClass("current_tap"),$(".detail_tap").removeClass("select"),$("#pingjia_tap").addClass("select"),$(".tap_content").removeClass("hide_right"),$(".tap_content").addClass("show_right");var n=$("#ajax-loading");o.current_timeout=window.setTimeout(function(){o.has_clickpj||(n.show(),$.ajax({url:"http://koubei.jumei.com/ajax/reports_aggregate.json?path=reports_aggregate.json&type="+o.type+"&product_id="+o.pingjia_id+"&rows_per_page=10&page=1&callback=jsonp1",type:"get",dataType:"jsonp",success:function(e){n.hide(),t.set_pingjia(e),o.has_clickpj=!0},error:function(){n.hide(),alert("口碑网络错误，请重试")}}))},450)}),$(window).scroll(function(){e=$("#detail_nav").offset().top,$(window).scrollTop()>=e?$(".detail_nav_inner").addClass("fix_top"):$(".detail_nav_inner").removeClass("fix_top")}),$(".more_pingjia").tap(function(){var e=$("#ajax-loading");o.report_index<o.report_pageCount&&(e.show(),o.report_index++,$.ajax({url:"http://koubei.jumei.com/ajax/reports_aggregate.json?path=reports_aggregate.json&type="+o.type+"&product_id="+o.pingjia_id+"&rows_per_page=10&page="+o.report_index+"&callback=jsonp1",type:"get",dataType:"jsonp",success:function(n){e.hide(),t.set_pingjia(n),o.has_clickpj=!0},error:function(){e.hide(),alert("更多口碑网络错误，请重试")}})),$(this).hide()}),$(".add_cart").click(function(){t.add_cart()}),$(".choose_size a").click(function(e){e.preventDefault(),t.choose_size(this)});var n=$(".alert_box");$("#sale_div").delegate(".sales_item_click","click",function(){var t=this.id,e="sales_info_"+t.substr(t.length-1,1);$(".show_sale_item").hide(),$("#"+e).show(),$(".show_sale_rules").show(),n.show(),$(".float_cover_bg").show(),n.animate({"margin-top":"100px"},"linear")}),$(".alert_box").delegate(".close_alert_btn","click",function(){$(".show_sale_rules").hide(),n.hide(),$(".float_cover_bg").hide(),n.css("margin-top","-400px")})},add_cart:function(){var t=this,e=$("#category").val();if($("#add_xinyuan").length>0&&s===!1){alert("请先登录，再添加");var i=window.location.href,a=$("#fromwx").val();return window.location.href=1==a?"http://wx.jumei.com/ExtConnect/index?act=microshop&url="+encodeURIComponent(i):"http://passport.jumei.com/i/mobile/login?redirect="+encodeURIComponent(i),!1}if(0===$("#add_shopping").length&&r===!0)return alert("此商品已在您的心愿列表中，不能重复添加"),!1;var c="";if("red_envelope"===o.type)c=","+o.item_id+",1";else if(c=$(".size_option.selected").find("input").val(),$("#only_one_size").length>=1&&(c=$("#only_one_size").val()),""===c||!c)return alert("请先选择尺寸"),!1;return $(".add_cart").addClass("select"),0===$("#add_shopping").length&&r===!1?$.ajax({url:"/user/wish_add?items="+c,type:"get",success:function(e){t.add_xy_callback(e)},error:function(){alert("加心愿单网络错误，请重试")}}):parseInt($(".detail_car_num").text())>=20?(alert("购物车最多只允许添加20个商品！"),$(".add_cart").removeClass("select")):n.add_shoping("detail_car","detail_car_num",c,e,t.add_car_callback),!1},add_xy_callback:function(t){var e=this;$("#add_xinyuan").removeClass("select"),1===t.result?e.guide_animate():alert(t.message)},choose_size:function(t){if(!$(t).hasClass("disabled")){$(".choose_size .size_option").removeClass("selected"),$(t).addClass("selected"),$(t).find("input").prop("checked",!0),$(t).find("input").attr("checked",!0);var e=$(t).find("input").data("pricedetail");if($("#mainProduct").text(e),location.href.indexOf("detail")>-1){var n=$(t).find("input").data("price");$("#newPrice").text(n)}}},guide_animate:function(){if(0===$(".add_car_animation").length){var t=$(".productPic img").attr("src");$(".productPic").append('<img  class="add_car_animation" src="'+t+'"/>')}var e=$(".add_car_animation");if("yes"!==e.attr("animation")){e.show(),$(".add_car_animation").animate({width:"0px",bottom:"0px",right:"97%","z-index":1},500,function(){});{setTimeout(function(){e.hide(),e.attr("animation","no"),e.css({width:"5rem",right:"30%",bottom:"70%","z-index":9999})},500)}e.attr("animation","yes")}},add_car_callback:function(t){$("#add_shopping").removeClass("select"),"success"===t.result&&c.guide_animate()},set_pingjia:function(t){var e=this;if(o.report_pageCount=t.data.pageCount,o.report_index=t.data.pageNumber,o.report_number=t.data.rowsPerPage,t.data.pageNumber===t.data.pageCount||0===t.data.pageCount||!t.data.rows||t.data.rows&&""===t.data.rows?$("#more_pingjia").hide():$("#more_pingjia").show(),t.data.rows&&""!==t.data.rows){var n=$("<ul>");for(var i in t.data.rows)n.append(e.set_pingjia_list(t.data.rows[i]));$("#detail_pingjia_inner").append(n)}else 1!==o.report_index&&o.report_index||$("#detail_pingjia_inner").append("<p>暂无评论信息</p>")},set_pingjia_list:function(t){if(!t.content_abstract_90||""===t.content_abstract_90||!t.report_id||""===t.report_id)return"";var e="<li>";return e+='<div class="clearfix"><a style = "color:#ED145B;font-size:15px;font-weight:bold" href="koubei?report_id='+t.report_id+'">'+decodeURIComponent(t.title)+"</a></div>",e+='<div class="little_gray">'+t.nickname+"(",e+=t.age&&""!==t.age&&"0"!==t.age?t.age+",":"未知年龄,",e+=t.skin_type&&""!==t.skin_type?t.skin_type+",":"未知肤质,",e+=t.hair_type&&""!==t.hair_type?t.hair_type+")</div>":"未知发质)</div>",e+='<div style = "font-size:14px;word-break:break-all;word-wrap:break-word;">',e+=t.content_abstract_90+'<a href="koubei?report_id='+t.report_id+'">[查看全部]</a></div>',e+='<div><span class="little_gray">阅读 '+t.shown_view_count+" | 回复 "+t.comment_count+"| 有用"+t.shown_support_count+"</span></div>",e+="</li>"},initGa:function(){$("#ga_go_check").length>0&&$("#ga_go_check").click(function(){Jumei.ja("button","go_check")}),$(".navTitle").length>0&&$(".navTitle").each(function(t){$(this).click(function(){switch(t){case 0:Jumei.ja("button","tuangou");break;case 1:Jumei.ja("button","mingpin");break;case 2:Jumei.ja("button","meizhuang")}})}),$(".add_cart").length>0&&$(".add_cart").click(function(){Jumei.ja("button","add_cart")}),$(".tab li").length>2&&$(".tab li").eq(2).click(function(){Jumei.ja("button","go_pc")}),$(".float_car").length>0&&$(".float_car").click(function(){Jumei.ja("button","cart_float")}),$(".search").length>0&&$(".search").click(function(){Jumei.ja("button","search")}),$(".cart_ico").length>0&&$(".cart_ico").click(function(){Jumei.ja("button","cart_edge")}),$("#ga_home_login").length>0&&$("#ga_home_login").click(function(){Jumei.ja("button","land_edge")}),$("#ga_login").length>0&&$("#ga_login").click(function(){Jumei.ja("button","land_now")}),$("#ga_home_register").length>0&&$("#ga_home_register").click(function(){Jumei.ja("button","register_egde")}),$("#ga_register").length>0&&$("#ga_register").click(function(){Jumei.ja("button","register_now")}),$("#download").length>0&&$("#download").click(function(){Jumei.ja("button","download_ijanstall")}),$("#commonBtn").length>0&&$("#commonBtn").click(function(){Jumei.ja("button","see_more")}),$(".jdetail").length>0&&$(".jdetail").click(function(){var t=$(this).attr("data-type");"allComment"==t&&Jumei.ja("button","allComment"),"goodComment"==t&&Jumei.ja("button","goodComment"),"middleComment"==t&&Jumei.ja("button","middleComment"),"badComment"==t&&Jumei.ja("button","badComment")})},priceRemmind:function(){var t=Jumei.getQueryString(location.href,"type"),e=$(".choose_size a"),n=null,i=$(".remmind-content .com-wrap"),a=null,o=$("#rePriceInfo"),s=o.attr("data-skudefault");(""===s||void 0===s)&&o.hide(),o.on("click",function(){if("undefined"!=t){if("global_combination_deal"==t||"global_combination_mall"==t){for(var o=0;o<e.length;o++)e.eq(o).hasClass("selected")&&(n=e.eq(o).find("input").attr("id").substring(4));for(var r=0;r<i.length;r++)a=i.eq(r).attr("data-itemsku"),null==n&&(n=s),a==n&&i.eq(r).show().siblings(".com-wrap").hide()}$("#remmindWrap").show()}}),$("#closeBtn,.remmind-mask").on("click",function(){$(i).show(),$("#remmindWrap").hide()})}};c.init()}),seajs.use(["detail"]);